# Prevent directory browsing
Options All -Indexes

# Protect htaccess
<Files ~ "^.*\.([Hh][Tt][AaPp])">
order allow,deny
deny from all
satisfy all
</Files>

RewriteEngine on
RewriteBase /

# Explicitely redirect any URL starting with /site/
RewriteCond %{ENV:REDIRECT_STATUS} ^$
RewriteRule ^site/(.*)$ /$1 [L,R=303]

# {type}/{slug}/{action} becomes {type}/{action}?slug={slug}
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} art/ [OR]
RewriteCond %{REQUEST_URI} tag/ [OR]
RewriteCond %{REQUEST_URI} category/
RewriteRule ^(\w+)/(\w+)/?(.*) $1/$3?$1=$2 [DPI]

# Iternally rebase all urls to the /site/ folder
RewriteCond %{REQUEST_URI} !^/site/
RewriteRule ^(.*)$ site/$1 [END]
